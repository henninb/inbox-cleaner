<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spam Rules Management - Inbox Cleaner</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; background: #f8f9fa; }
        .container { max-width: 1400px; margin: 0 auto; }
        nav { margin-bottom: 30px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        nav a { margin-right: 20px; text-decoration: none; color: #007bff; font-weight: 500; }
        nav a:hover { text-decoration: underline; }
        
        .rule-section { background: white; margin: 20px 0; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .rule-section h2 { margin-top: 0; color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #495057; }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; 
            font-size: 14px; box-sizing: border-box; 
        }
        .form-group textarea { resize: vertical; height: 80px; }
        
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; text-decoration: none; display: inline-block; margin-right: 10px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-success { background: #28a745; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:hover { opacity: 0.9; }
        
        .rule-item { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 15px 0; }
        .rule-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .rule-type { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .rule-type.domain { background: #e3f2fd; color: #1976d2; }
        .rule-type.subject { background: #f3e5f5; color: #7b1fa2; }
        .rule-type.sender { background: #e8f5e8; color: #388e3c; }
        
        .rule-status { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .rule-status.active { background: #d4edda; color: #155724; }
        .rule-status.inactive { background: #f8d7da; color: #721c24; }
        
        .rule-actions { display: flex; gap: 10px; margin-top: 15px; }
        
        .alert { padding: 15px; margin: 15px 0; border-radius: 8px; }
        .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .alert-danger { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .alert-info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 2rem; font-weight: bold; color: #007bff; }
        
        .loading { text-align: center; padding: 40px; color: #6c757d; }
        .error { text-align: center; padding: 40px; color: #dc3545; }
        
        .preview-section { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin: 15px 0; }
        .preview-email { background: white; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; margin: 8px 0; font-size: 14px; }
        
        #create-rule-form { display: none; }
        .form-toggle { cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è Spam Rules Management</h1>
        
        <nav>
            <a href="/dashboard">Dashboard</a>
            <a href="/emails">Email List</a>
            <a href="/search">Search</a>
            <a href="/analysis">Analysis</a>
            <a href="/spam-rules">Spam Rules</a>
        </nav>
        
        <!-- Stats Overview -->
        <div id="stats-section" class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-rules">0</div>
                <div>Total Rules</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="active-rules">0</div>
                <div>Active Rules</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="deletion-rules">0</div>
                <div>Deletion Rules</div>
            </div>
        </div>
        
        <!-- Create New Rule Section -->
        <div class="rule-section">
            <h2 class="form-toggle" onclick="toggleRuleForm()">‚ûï Create New Spam Rule</h2>
            
            <form id="create-rule-form" onsubmit="createSpamRule(event)">
                <div class="form-group">
                    <label for="rule-type">Rule Type:</label>
                    <select id="rule-type" onchange="updateRuleForm()">
                        <option value="domain">Domain (e.g., block all emails from m.jabra.com)</option>
                        <option value="subject">Subject Pattern (regex)</option>
                        <option value="sender">Sender Pattern (regex)</option>
                    </select>
                </div>
                
                <div class="form-group" id="domain-field">
                    <label for="domain">Domain to Block:</label>
                    <input type="text" id="domain" placeholder="e.g., m.jabra.com" />
                </div>
                
                <div class="form-group" id="pattern-field" style="display: none;">
                    <label for="pattern">Pattern (Regular Expression):</label>
                    <input type="text" id="pattern" placeholder="e.g., URGENT.*ACT NOW" />
                </div>
                
                <div class="form-group">
                    <label for="action">Action:</label>
                    <select id="action">
                        <option value="delete">Delete</option>
                        <option value="archive">Archive</option>
                        <option value="label">Add Label</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="reason">Reason:</label>
                    <textarea id="reason" placeholder="Explain why this rule is needed..." required></textarea>
                </div>
                
                <button type="submit" class="btn btn-primary">Create Rule</button>
                <button type="button" class="btn btn-secondary" onclick="previewRule()">Preview</button>
            </form>
            
            <div id="rule-preview" class="preview-section" style="display: none;">
                <h4>‚ö†Ô∏è Preview - Emails that would be affected:</h4>
                <div id="preview-content"></div>
            </div>
        </div>
        
        <!-- Existing Rules Section -->
        <div class="rule-section">
            <h2>üìã Existing Spam Rules</h2>
            
            <div id="rules-loading" class="loading">Loading spam rules...</div>
            <div id="rules-error" class="error" style="display: none;">Error loading rules</div>
            <div id="rules-list"></div>
            
            <div id="no-rules" style="display: none;" class="alert alert-info">
                <h4>No spam rules configured</h4>
                <p>Create your first spam rule above to automatically manage unwanted emails.</p>
                <p><strong>Example:</strong> Block all emails from <code>m.jabra.com</code> to stop promotional emails.</p>
            </div>
        </div>
        
        <!-- Quick Actions Section -->
        <div class="rule-section">
            <h2>‚ö° Quick Actions</h2>
            
            <div class="alert alert-info">
                <h4>üéØ Suggested Rules Based on Your Data</h4>
                <p>Create rules for domains with many promotional emails:</p>
                <div id="suggested-rules">
                    <button class="btn btn-warning" onclick="createDomainRule('m.jabra.com')">
                        Block m.jabra.com (76 emails)
                    </button>
                    <button class="btn btn-warning" onclick="createDomainRule('target.com')">
                        Block promotional from target.com (175 emails)
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <h4>üóëÔ∏è Bulk Deletion Tools</h4>
                <button class="btn btn-danger" onclick="showBulkDeleteOptions()">
                    Bulk Delete by Domain
                </button>
                <button class="btn btn-warning" onclick="applyAllRules()">
                    Apply All Rules to Existing Emails
                </button>
            </div>
        </div>
        
        <!-- Alerts -->
        <div id="alerts-container"></div>
    </div>
    
    <script>
        let currentRules = [];
        
        // Load spam rules on page load
        async function loadSpamRules() {
            try {
                const response = await fetch('/api/spam-rules');
                const data = await response.json();
                
                if (data.error) {
                    showError('Error loading rules: ' + data.error);
                    return;
                }
                
                currentRules = data.rules || [];
                updateStats(data.stats || {});
                displayRules(currentRules);
                
                document.getElementById('rules-loading').style.display = 'none';
                
            } catch (error) {
                showError('Failed to load rules: ' + error.message);
                document.getElementById('rules-loading').style.display = 'none';
                document.getElementById('rules-error').style.display = 'block';
            }
        }
        
        function updateStats(stats) {
            document.getElementById('total-rules').textContent = stats.total_rules || 0;
            document.getElementById('active-rules').textContent = stats.active_rules || 0;
            document.getElementById('deletion-rules').textContent = stats.deletion_rules || 0;
        }
        
        function displayRules(rules) {
            const container = document.getElementById('rules-list');
            
            if (rules.length === 0) {
                container.style.display = 'none';
                document.getElementById('no-rules').style.display = 'block';
                return;
            }
            
            document.getElementById('no-rules').style.display = 'none';
            container.style.display = 'block';
            
            let html = '';
            rules.forEach(rule => {
                const statusClass = rule.active ? 'active' : 'inactive';
                const statusText = rule.active ? 'Active' : 'Inactive';
                
                let ruleDescription = '';
                if (rule.type === 'domain') {
                    ruleDescription = `Block all emails from <strong>${rule.domain}</strong>`;
                } else if (rule.type === 'subject') {
                    ruleDescription = `Subject matches pattern: <code>${rule.pattern}</code>`;
                } else if (rule.type === 'sender') {
                    ruleDescription = `Sender matches pattern: <code>${rule.pattern}</code>`;
                }
                
                html += `
                    <div class="rule-item">
                        <div class="rule-header">
                            <div>
                                <span class="rule-type ${rule.type}">${rule.type}</span>
                                <span class="rule-status ${statusClass}">${statusText}</span>
                            </div>
                            <div>
                                <small>Created: ${new Date(rule.created_at).toLocaleDateString()}</small>
                            </div>
                        </div>
                        
                        <div style="margin: 10px 0;">
                            ${ruleDescription}
                        </div>
                        
                        <div style="margin: 10px 0; color: #6c757d;">
                            <strong>Action:</strong> ${rule.action} | <strong>Reason:</strong> ${rule.reason}
                        </div>
                        
                        <div class="rule-actions">
                            <button class="btn btn-success" onclick="applyRule('${rule.rule_id}', true)">
                                Preview Apply
                            </button>
                            <button class="btn btn-primary" onclick="applyRule('${rule.rule_id}', false)">
                                Apply Rule
                            </button>
                            <button class="btn btn-warning" onclick="toggleRule('${rule.rule_id}')">
                                ${rule.active ? 'Disable' : 'Enable'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteRule('${rule.rule_id}')">
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function toggleRuleForm() {
            const form = document.getElementById('create-rule-form');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }
        
        function updateRuleForm() {
            const ruleType = document.getElementById('rule-type').value;
            const domainField = document.getElementById('domain-field');
            const patternField = document.getElementById('pattern-field');
            
            if (ruleType === 'domain') {
                domainField.style.display = 'block';
                patternField.style.display = 'none';
            } else {
                domainField.style.display = 'none';
                patternField.style.display = 'block';
            }
        }
        
        async function createSpamRule(event) {
            event.preventDefault();
            
            const ruleType = document.getElementById('rule-type').value;
            const domain = document.getElementById('domain').value;
            const pattern = document.getElementById('pattern').value;
            const action = document.getElementById('action').value;
            const reason = document.getElementById('reason').value;
            
            if (!reason.trim()) {
                showAlert('Please provide a reason for this rule', 'danger');
                return;
            }
            
            const ruleData = {
                rule_type: ruleType,
                action: action,
                reason: reason
            };
            
            if (ruleType === 'domain') {
                if (!domain.trim()) {
                    showAlert('Please enter a domain', 'danger');
                    return;
                }
                ruleData.domain = domain;
            } else {
                if (!pattern.trim()) {
                    showAlert('Please enter a pattern', 'danger');
                    return;
                }
                ruleData.pattern = pattern;
            }
            
            try {
                const response = await fetch('/api/spam-rules', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(ruleData)
                });
                
                if (response.ok) {
                    const rule = await response.json();
                    showAlert(`Rule created successfully: ${rule.rule_id}`, 'success');
                    
                    // Clear form
                    document.getElementById('create-rule-form').reset();
                    document.getElementById('create-rule-form').style.display = 'none';
                    
                    // Reload rules
                    loadSpamRules();
                } else {
                    const error = await response.json();
                    showAlert('Failed to create rule: ' + (error.detail || 'Unknown error'), 'danger');
                }
            } catch (error) {
                showAlert('Error creating rule: ' + error.message, 'danger');
            }
        }
        
        async function deleteRule(ruleId) {
            if (!confirm('Are you sure you want to delete this spam rule?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/spam-rules/${ruleId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('Rule deleted successfully', 'success');
                    loadSpamRules();
                } else {
                    const error = await response.json();
                    showAlert('Failed to delete rule: ' + (error.detail || 'Unknown error'), 'danger');
                }
            } catch (error) {
                showAlert('Error deleting rule: ' + error.message, 'danger');
            }
        }
        
        async function toggleRule(ruleId) {
            try {
                const response = await fetch(`/api/spam-rules/${ruleId}/toggle`, {
                    method: 'PUT'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const status = result.rule.active ? 'enabled' : 'disabled';
                    showAlert(`Rule ${status} successfully`, 'success');
                    loadSpamRules();
                } else {
                    const error = await response.json();
                    showAlert('Failed to toggle rule: ' + (error.detail || 'Unknown error'), 'danger');
                }
            } catch (error) {
                showAlert('Error toggling rule: ' + error.message, 'danger');
            }
        }
        
        async function applyRule(ruleId, dryRun = true) {
            try {
                const response = await fetch(`/api/apply-rule/${ruleId}?dry_run=${dryRun}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (dryRun) {
                        showAlert(`Preview: Would affect ${result.total_found} emails`, 'info');
                        // Show preview details
                        if (result.would_delete && result.would_delete.length > 0) {
                            let previewHtml = `<h5>Would delete ${result.total_found} emails:</h5>`;
                            result.would_delete.slice(0, 5).forEach(email => {
                                previewHtml += `<div class="preview-email">
                                    <strong>${email.sender_domain}</strong> - ${email.subject}
                                </div>`;
                            });
                            if (result.would_delete.length > 5) {
                                previewHtml += `<p>...and ${result.would_delete.length - 5} more</p>`;
                            }
                            
                            const previewSection = document.getElementById('rule-preview');
                            document.getElementById('preview-content').innerHTML = previewHtml;
                            previewSection.style.display = 'block';
                        }
                    } else {
                        const deleted = result.database_deleted || 0;
                        showAlert(`Rule applied! Deleted ${deleted} emails from database`, 'success');
                    }
                } else {
                    const error = await response.json();
                    showAlert('Failed to apply rule: ' + (error.detail || 'Unknown error'), 'danger');
                }
            } catch (error) {
                showAlert('Error applying rule: ' + error.message, 'danger');
            }
        }
        
        async function createDomainRule(domain) {
            // Pre-fill the form with the suggested domain
            document.getElementById('rule-type').value = 'domain';
            document.getElementById('domain').value = domain;
            document.getElementById('action').value = 'delete';
            document.getElementById('reason').value = `Excessive promotional emails from ${domain}`;
            
            updateRuleForm();
            document.getElementById('create-rule-form').style.display = 'block';
            
            // Scroll to form
            document.getElementById('create-rule-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        function showAlert(message, type) {
            const alertsContainer = document.getElementById('alerts-container');
            const alertClass = `alert-${type}`;
            
            const alertHtml = `
                <div class="alert ${alertClass}" style="margin-top: 20px;">
                    ${message}
                    <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; font-size: 18px; cursor: pointer;">&times;</button>
                </div>
            `;
            
            alertsContainer.innerHTML = alertHtml + alertsContainer.innerHTML;
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const firstAlert = alertsContainer.firstElementChild;
                if (firstAlert) firstAlert.remove();
            }, 5000);
        }
        
        function showError(message) {
            showAlert(message, 'danger');
        }
        
        // Load rules when page loads
        loadSpamRules();
    </script>
</body>
</html>